# Архитектура проекта Screeps

## Общая структура

```mermaid
graph TD
    A[main.js] --> B[CreepBase]
    B --> C[Harvester]
    B --> D[Builder]
    B --> E[Carrier]
    B --> F[Attacker]
```

Проект построен на основе объектно-ориентированного подхода с использованием классов для управления различными типами крипов.

## Основные компоненты

### 1. Базовый класс крипа (CreepBase.js)
```mermaid
classDiagram
    class CreepBase {
        +handleState()
        +setState(newState)
        +handleIdleState()
        +handleMovingState()
        +handleWorkingState()
        +handleRenewingState()
        +handleDyingState()
    }
```
- Содержит общую логику для всех типов крипов
- Определяет основные состояния крипа:
  - IDLE (ожидание)
  - MOVING (передвижение)
  - WORKING (работа)
  - RENEWING (обновление)
  - DYING (смерть)
- Реализует базовые методы для управления состояниями

### 2. Специализированные классы крипов

```mermaid
classDiagram
    CreepBase <|-- Harvester
    CreepBase <|-- Builder
    CreepBase <|-- Carrier
    CreepBase <|-- Attacker
    
    class Harvester {
        +handleIdleState()
        +handleWorkingState()
    }
    class Builder {
        +handleIdleState()
        +handleWorkingState()
    }
    class Carrier {
        +handleIdleState()
        +handleWorkingState()
        +findEnergyTarget()
    }
    class Attacker {
        +handleIdleState()
        +handleWorkingState()
    }
```

#### Harvester (Harvester.js)
- Сборщик энергии
- Основные функции:
  - Поиск ближайшего активного источника энергии
  - Добыча энергии
  - Перемещение к источнику

#### Builder (Builder.js)
- Строитель
- Основные функции:
  - Поиск ближайшей стройплощадки
  - Строительство структур
  - Перемещение к стройплощадке

#### Carrier (Carrier.js)
- Переносчик
- Основные функции:
  - Поиск целей для переноса энергии
  - Перенос энергии между структурами
  - Приоритеты целей:
    1. Хранилище (storage)
    2. Контроллер для улучшения
    3. Спавнеры и расширения

#### Attacker (Attacker.js)
- Атакующий
- Основные функции:
  - Поиск вражеских крипов
  - Атака врагов
  - Перемещение к цели

### 3. Основной файл (main.js)
```mermaid
flowchart TD
    A[main.js] --> B[Очистка памяти]
    A --> C[Обработка крипов]
    A --> D[Управление спавном]
    
    B --> E[Удаление мертвых крипов]
    C --> F[Создание менеджеров]
    C --> G[Обработка состояний]
    D --> H[Подсчет крипов]
    D --> I[Создание новых]
```
- Управляет всем игровым циклом
- Основные функции:
  - Очистка памяти мертвых крипов
  - Создание и управление крипами
  - Управление спавном новых крипов
  - Распределение ролей

## Система состояний крипов

```mermaid
stateDiagram-v2
    [*] --> IDLE
    IDLE --> MOVING: Найдена цель
    MOVING --> WORKING: Достиг цели
    WORKING --> IDLE: Задача выполнена
    WORKING --> MOVING: Цель недоступна
    MOVING --> IDLE: Нет пути
    IDLE --> RENEWING: Нужно обновление
    RENEWING --> IDLE: Обновлен
    IDLE --> DYING: Мало энергии
    DYING --> [*]: Умер
```

Каждый крип может находиться в одном из следующих состояний:
1. IDLE - ожидание новой задачи
2. MOVING - перемещение к цели
3. WORKING - выполнение основной задачи
4. RENEWING - обновление в спавнере
5. DYING - подготовка к смерти

## Управление спавном

```mermaid
flowchart TD
    A[Управление спавном] --> B{Достаточно энергии?}
    B -->|Да| C[Проверка количества крипов]
    B -->|Нет| D[Ожидание]
    C --> E{Нужны сборщики?}
    E -->|Да| F[Создать сборщика]
    E -->|Нет| G{Нужны строители?}
    G -->|Да| H[Создать строителя]
    G -->|Нет| I{Нужны переносчики?}
    I -->|Да| J[Создать переносчика]
    I -->|Нет| K{Нужны атакующие?}
    K -->|Да| L[Создать атакующего]
```

Система автоматически создает крипов в зависимости от потребностей:
- Приоритеты создания:
  1. 2 сборщика энергии
  2. 1 строитель
  3. 2 переносчика
  4. 1 атакующий

## Конфигурация тел крипов

```mermaid
classDiagram
    class CreepBodies {
        +Harvester: [WORK, CARRY, MOVE]
        +Builder: [WORK, CARRY, MOVE]
        +Carrier: [CARRY, CARRY, MOVE, MOVE]
        +Attacker: [ATTACK, MOVE]
    }
```

Каждый тип крипа имеет оптимальную конфигурацию тела:
- Сборщики и строители: WORK, CARRY, MOVE
- Переносчики: CARRY, CARRY, MOVE, MOVE
- Атакующие: ATTACK, MOVE

## Логирование

```mermaid
flowchart TD
    A[Логирование] --> B[Очистка памяти]
    A --> C[Установка ролей]
    A --> D[Обработка ошибок]
    B --> E[Удаление мертвых крипов]
    C --> F[Роль по умолчанию]
    D --> G[Неизвестные роли]
```

Система включает в себя базовое логирование:
- Очистка памяти мертвых крипов
- Установка ролей по умолчанию
- Обработка ошибок и неизвестных ролей