// –≠—Ç–∞ —Å—Ç—Ä–æ—á–∫–∞ –æ–±—ä—è–≤–ª—è–µ—Ç –≥–ª–∞–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –∏–≥—Ä–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞
module.exports.loop = function () {
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–º—è –Ω–∞—à–µ–≥–æ –∫—Ä–∏–ø–∞ –∏ –µ–≥–æ —á–∞—Å—Ç–∏ —Ç–µ–ª–∞
    const creepName = 'Harvester1';
    const creepBody = [WORK, CARRY, MOVE]; // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –Ω–∞–±–æ—Ä: —Ä–∞–±–æ—Ç–∞, –ø–µ—Ä–µ–Ω–æ—Å–∫–∞, –¥–≤–∏–∂–µ–Ω–∏–µ
    const energyRequired = 200; // –°—Ç–æ–∏–º–æ—Å—Ç—å WORK(100) + CARRY(50) + MOVE(50)

    // --- –õ–æ–≥–∏–∫–∞ –¥–ª—è —Å–ø–∞–≤–Ω–∞ ---
    // –ü–æ–ª—É—á–∞–µ–º –Ω–∞—à –≥–ª–∞–≤–Ω—ã–π —Å–ø–∞–≤–Ω (–æ–±—ã—á–Ω–æ 'Spawn1')
    var spawn = Game.spawns['Spawn1']; // –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–∞—à —Å–ø–∞–≤–Ω –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è Spawn1

    // –ï—Å–ª–∏ –∫—Ä–∏–ø–∞ —Å –Ω—É–∂–Ω—ã–º –∏–º–µ–Ω–µ–º –Ω–µ—Ç, –ø—ã—Ç–∞–µ–º—Å—è –µ–≥–æ —Å–æ–∑–¥–∞—Ç—å
    if (!Game.creeps[creepName] && spawn && !spawn.spawning) {
        console.log('–ö—Ä–∏–ø–∞ ' + creepName + ' –Ω–µ—Ç. –ü—ã—Ç–∞–µ–º—Å—è —Å–æ–∑–¥–∞—Ç—å...');
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ —ç–Ω–µ—Ä–≥–∏–∏ –≤ –∫–æ–º–Ω–∞—Ç–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫—Ä–∏–ø–∞
        if (spawn.room.energyAvailable >= energyRequired) {
            var spawnResult = spawn.spawnCreep(creepBody, creepName);
            if (spawnResult == OK) {
                console.log('–ù–∞—á–∞—Ç–æ —Å–æ–∑–¥–∞–Ω–∏–µ –∫—Ä–∏–ø–∞: ' + creepName);
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ –∫—Ä–∏–ø–∞ –≤ –µ–≥–æ –ø–∞–º—è—Ç—å
                // –ü–∞–º—è—Ç—å –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞ —Å–ø–∞–≤–Ω–∞
                 if(Memory.creeps && !Memory.creeps[creepName]) { // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
                     Memory.creeps[creepName] = { 
                         harvesting: true,    // –¥–æ–±—ã—á–∞ —ç–Ω–µ—Ä–≥–∏–∏
                         upgrading: false     // —É–ª—É—á—à–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
                     }; // –ù–∞—á–∏–Ω–∞–µ–º —Å –¥–æ–±—ã—á–∏
                     console.log('–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è ' + creepName);
                 }
            } else {
                console.log('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —Å–æ–∑–¥–∞—Ç—å –∫—Ä–∏–ø–∞ ' + creepName + ': ' + spawnResult);
            }
        } else {
            console.log('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —ç–Ω–µ—Ä–≥–∏–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è ' + creepName + '. –ù—É–∂–Ω–æ ' + energyRequired + ', –¥–æ—Å—Ç—É–ø–Ω–æ ' + spawn.room.energyAvailable);
        }
    } else if (spawn && spawn.spawning && spawn.spawning.name == creepName) {
        // –ï—Å–ª–∏ —Å–ø–∞–≤–Ω –∑–∞–Ω—è—Ç —Å–æ–∑–¥–∞–Ω–∏–µ–º –ù–ê–®–ï–ì–û –∫—Ä–∏–ø–∞, –≤—ã–≤–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        console.log(spawn.name + ' —Å–æ–∑–¥–∞–µ—Ç ' + creepName + '...');
        // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –Ω–∞ —Å–ø–∞–≤–Ω
        spawn.room.visual.text(
            'üõ†Ô∏è' + creepName,
            spawn.pos.x + 1,
            spawn.pos.y,
            {align: 'left', opacity: 0.8});
    }

    // --- –õ–æ–≥–∏–∫–∞ –¥–ª—è –∫—Ä–∏–ø–∞ ---
    var creep = Game.creeps[creepName];
    if (creep) {
        // –ï—Å–ª–∏ –∫—Ä–∏–ø –µ—â–µ –Ω–µ —Ä–æ–¥–∏–ª—Å—è (spawning), –æ–Ω –Ω–∏—á–µ–≥–æ –Ω–µ –º–æ–∂–µ—Ç –¥–µ–ª–∞—Ç—å
        if (creep.spawning) {
             console.log(creepName + ' –µ—â–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è (–≤ —Å–ø–∞–≤–Ω–µ).');
            return; // –í—ã—Ö–æ–¥–∏–º –∏–∑ –ª–æ–≥–∏–∫–∏ –¥–ª—è —ç—Ç–æ–≥–æ –∫—Ä–∏–ø–∞ –Ω–∞ —ç—Ç–æ—Ç —Ç–∏–∫
        }

        // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∫—Ä–∏–ø–∞ ---
        // –ï—Å–ª–∏ –∫—Ä–∏–ø –ø—É—Å—Ç–æ–π, –∏–¥—ë–º –¥–æ–±—ã–≤–∞—Ç—å
        if (!creep.memory.harvesting && creep.store.getUsedCapacity() == 0) {
            creep.memory.harvesting = true;
            creep.memory.upgrading = false;
            creep.say('‚ö° –¥–æ–±—ã–≤–∞—é');
            console.log(creepName + ' –æ–ø—É—Å—Ç–µ–ª, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ –¥–æ–±—ã—á—É —ç–Ω–µ—Ä–≥–∏–∏.');
        }
        // –ï—Å–ª–∏ –∫—Ä–∏–ø –ø–æ–ª–Ω—ã–π, —Ä–µ—à–∞–µ–º —á—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ
        if (creep.memory.harvesting && creep.store.getFreeCapacity() == 0) {
            creep.memory.harvesting = false;
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–ª–æ–Ω –ª–∏ —Å–ø–∞–≤–Ω
            if (spawn.store.getFreeCapacity(RESOURCE_ENERGY) == 0) {
                creep.memory.upgrading = true;
                creep.say('‚ö° —É–ª—É—á—à–∞—é');
                console.log(creepName + ' –∏–¥–µ—Ç —É–ª—É—á—à–∞—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä');
            } else {
                creep.memory.upgrading = false;
                creep.say('üîÑ –Ω–µ—Å—É');
                console.log(creepName + ' –Ω–µ—Å–µ—Ç —ç–Ω–µ—Ä–≥–∏—é –≤ —Å–ø–∞–≤–Ω');
            }
        }

        // --- –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è ---
        if (creep.memory.harvesting) {
            // –î–æ–±—ã—á–∞ —ç–Ω–µ—Ä–≥–∏–∏
            var sources = creep.room.find(FIND_SOURCES);
            if (sources.length > 0) {
                var harvestResult = creep.harvest(sources[0]);
                if (harvestResult == ERR_NOT_IN_RANGE) {
                    creep.moveTo(sources[0], { visualizePathStyle: { stroke: '#ffaa00' } }); // –ñ–µ–ª—Ç—ã–π –ø—É—Ç—å –∫ –∏—Å—Ç–æ—á–Ω–∏–∫—É
                } else if (harvestResult != OK && harvestResult != ERR_BUSY) {
                     console.log(creepName + ' –æ—à–∏–±–∫–∞ –¥–æ–±—ã—á–∏: ' + harvestResult);
                }
            } else {
                 console.log(creepName + ' –Ω–µ –Ω–∞—à–µ–ª –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —ç–Ω–µ—Ä–≥–∏–∏!');
            }
        } else if (creep.memory.upgrading) {
            // –£–ª—É—á—à–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
            if (creep.upgradeController(creep.room.controller) == ERR_NOT_IN_RANGE) {
                creep.moveTo(creep.room.controller, { visualizePathStyle: { stroke: '#ffffff' } });
            }
        } else {
            // –ü–µ—Ä–µ–Ω–æ—Å —ç–Ω–µ—Ä–≥–∏–∏ –≤ —Å–ø–∞–≤–Ω
            if (spawn) { // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Å–ø–∞–≤–Ω –Ω–∞–π–¥–µ–Ω
                var transferResult = creep.transfer(spawn, RESOURCE_ENERGY);
                if (transferResult == ERR_NOT_IN_RANGE) {
                    creep.moveTo(spawn, { visualizePathStyle: { stroke: '#ffffff' } }); // –ë–µ–ª—ã–π –ø—É—Ç—å –∫ —Å–ø–∞–≤–Ω—É
                } else if (transferResult == ERR_FULL) {
                     console.log(creepName + ': –°–ø–∞–≤–Ω ' + spawn.name + ' –ø–æ–ª–æ–Ω —ç–Ω–µ—Ä–≥–∏–∏.');
                     // –ï—Å–ª–∏ —Å–ø–∞–≤–Ω –ø–æ–ª–æ–Ω, –∏–¥–µ–º —É–ª—É—á—à–∞—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä
                     var controller = creep.room.controller;
                     if (controller) {
                         var upgradeResult = creep.upgradeController(controller);
                         if (upgradeResult == ERR_NOT_IN_RANGE) {
                             creep.moveTo(controller, { visualizePathStyle: { stroke: '#ffffff' } });
                         }
                         console.log(creepName + ' —É–ª—É—á—à–∞–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä');
                     }
                } else if (transferResult != OK) {
                    console.log(creepName + ' –æ—à–∏–±–∫–∞ –ø–µ—Ä–µ–¥–∞—á–∏ —ç–Ω–µ—Ä–≥–∏–∏: ' + transferResult);
                }
            } else {
                console.log(creepName + ' –Ω–µ –º–æ–∂–µ—Ç –Ω–∞–π—Ç–∏ —Å–ø–∞–≤–Ω ' + 'Spawn1' + ' –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ —ç–Ω–µ—Ä–≥–∏–∏!');
            }
        }
    } else if (!spawn) {
         console.log('–û—à–∏–±–∫–∞: –°–ø–∞–≤–Ω —Å –∏–º–µ–Ω–µ–º \'Spawn1\' –Ω–µ –Ω–∞–π–¥–µ–Ω! –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –∫—Ä–∏–ø–∞.');
    }
    // (–ï—Å–ª–∏ –∫—Ä–∏–ø–∞ –Ω–µ—Ç –∏ —Å–ø–∞–≤–Ω –∑–∞–Ω—è—Ç —Å–æ–∑–¥–∞–Ω–∏–µ–º –ù–ï –Ω–∞—à–µ–≥–æ –∫—Ä–∏–ø–∞, –º—ã –ø—Ä–æ—Å—Ç–æ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º –∏ –∂–¥–µ–º)
}